<!DOCTYPE html>
<html lang="en">
    <head prefix="og: https://ogp.me/ns#">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="color-scheme" content="light dark">
  
  <title>Grafana Server Monitor - OwlllOvO&#39;s Blog</title>
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    <link rel='manifest' href='/manifest.json'>
  

  
  
  
  <meta property="og:title" content="Grafana Server Monitor - OwlllOvO&#39;s Blog" />
  
  <meta property="og:type" content="article" />
  
  <meta property="og:url" content="http://example.com/2024/08/02/2024-08-02-grafana-server-monitor/index.html" />
  
  <meta property="og:image" content="https://raw.githubusercontent.com/OwlllOvO/Hexo-image/main/20240802194400.png" />
  
  <meta property="og:article:published_time" content="2024-08-01T16:00:00.000Z" />
  
  <meta property="og:article:author" content="OwlllOvO" />
  
  

  
<link rel="stylesheet" href="/css/var.css">

  
<link rel="stylesheet" href="/css/main.css">

  
<link rel="stylesheet" href="/css/typography.css">

  
<link rel="stylesheet" href="/css/code-highlighting.css">

  
<link rel="stylesheet" href="/css/components.css">

  
<link rel="stylesheet" href="/css/nav.css">

  
<link rel="stylesheet" href="/css/paginator.css">

  
<link rel="stylesheet" href="/css/footer.css">

  
<link rel="stylesheet" href="/css/post-list.css">

  
  
<link rel="stylesheet" href="/css/rainbow-banner.css">

  
  
  
<link rel="stylesheet" href="/css/toc.css">

  
  
  
  
  
<link rel="stylesheet" href="/css/post.css">

  
  
  
  
  

  
<meta name="generator" content="Hexo 7.3.0"></head>
    <body
        data-color-scheme="auto"
        data-uppercase-categories="true"
        
        data-rainbow-banner="true"
        data-rainbow-banner-shown="auto"
        data-rainbow-banner-month="6"
        data-rainbow-banner-colors="#e50000,#ff8d00,#ffee00,#008121,#004cff,#760188"
        
        data-config-root="/"
        
        data-toc="true"
        data-toc-max-depth="6"
        
        
    >
        <nav id="theme-nav">
    <div class="inner">
        <a class="title" href="/">Blog</a>
        <div class="nav-arrow"></div>
        <div class="nav-items">
            <a class="nav-item nav-item-home" href="/">Home</a>
            
            
            <a class="nav-item" href="/archives">Archives</a>
            
            
            
            <a class="nav-item" href="/friends">Friends</a>
            
            
            
            <a class="nav-item" href="/projects">Projects</a>
            
            
            
            <a class="nav-item" href="/about">About</a>
            
            
            
            <a class="nav-item nav-item-github nav-item-icon" href="https://github.com/OwlllOvO" target="_blank" aria-label="GitHub">&nbsp;</a>
            
            
            
            <a class="nav-item nav-item-search nav-item-icon" href="/search" target="_blank" aria-label="Search">&nbsp;</a>
            
            
        </div>
    </div>
</nav>
        
<article class="post">
    <div class="meta">
        
        <div class="categories text-uppercase">
        
            <a href="/categories/Tech/">Tech</a>
        
        </div>
        

        
        <div class="date" id="date">
            <span>August</span>
            <span>2,</span>
            <span>2024</span>
        </div>
        

        <h1 class="title">Grafana Server Monitor</h1>
    </div>

    <div class="divider"></div>

    <div class="content">
        <h1 id="Grafana-Server-Monitor"><a href="#Grafana-Server-Monitor" class="headerlink" title="Grafana Server Monitor"></a>Grafana Server Monitor</h1><p>如果购置了多台服务器，就需要一个服务器监控程序来查看它们的运行状态</p>
<p>最开始我是用的是探针，如那吒监控、ServerStatus</p>
<p>但是哪吒监控经常出各种 bug，ServerStatus 依靠大佬们个人维护，有好几个已经停更了</p>
<p>于是想重新找一个开源工具搭建</p>
<p>Grafana + Prometheus + node_exporter 就是一个非常好的服务器状态监控解决方案</p>
<ul>
<li>node_exporter 运行在客户极上，将收集到的系统数据按格式整理好放在网页上</li>
<li>Prometheus 定期到客户机收集数据，按时间序列保存</li>
<li>Grafana 从 Prometheus 读取数据，将数据按时间序列显示为图表等形式</li>
</ul>
<h2 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h2><p><img src="https://raw.githubusercontent.com/OwlllOvO/Hexo-image/main/20240802140652.png"></p>
<p><img src="https://raw.githubusercontent.com/OwlllOvO/Hexo-image/main/20240802141231.png"></p>
<h2 id="Install"><a href="#Install" class="headerlink" title="Install"></a>Install</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt update</span><br><span class="line">apt install ufw</span><br><span class="line">ufw allow 22</span><br><span class="line">ufw <span class="built_in">enable</span></span><br></pre></td></tr></table></figure>

<h3 id="Clients-node-exporter"><a href="#Clients-node-exporter" class="headerlink" title="(Clients) node_exporter"></a>(Clients) node_exporter</h3><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/prometheus/node_exporter/releases/latest">Latest Release · prometheus&#x2F;node_exporter</a></p>
<p>  用最新版本替换</p>
</li>
</ul>
<p>在每个客户机上执行以下内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/node_exporter/releases/download/v1.8.2/node_exporter-1.8.2.linux-amd64.tar.gz</span><br><span class="line">tar -xzvf node_exporter-1.8.2.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mv</span> node_exporter-1.8.2.linux-amd64/node_exporter /usr/local/bin</span><br><span class="line"><span class="built_in">rm</span> node_exporter-*.tar.gz</span><br><span class="line"><span class="built_in">rm</span> -r node_exporter-*.linux-amd64*</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> useradd -rs /bin/false node_exporter</span><br><span class="line">vim /etc/systemd/system/node_exporter.service</span><br></pre></td></tr></table></figure>

<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=node_exporter</span><br><span class="line"><span class="attr">Wants</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"><span class="attr">After</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">User</span>=node_exporter</span><br><span class="line"><span class="attr">Group</span>=node_exporter</span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"><span class="attr">RestartSec</span>=<span class="number">5</span>s</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/node_exporter</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl enable --now node_exporter</span><br><span class="line">sudo systemctl status node_exporter</span><br></pre></td></tr></table></figure>

<ul>
<li>此时可以使用 <code>&lt;Server IP&gt;:9100/metrics</code> 查看导出的数据</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw allow from &lt;Server IP&gt; to any port 9100 comment <span class="string">&#x27;node_exporter&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="Server-Prometheus"><a href="#Server-Prometheus" class="headerlink" title="(Server) Prometheus"></a>(Server) Prometheus</h3><ul>
<li><p>Prometheus 官网：<a target="_blank" rel="noopener" href="https://prometheus.io/">Prometheus</a></p>
</li>
<li><p>Prometheus Latest Release：<a target="_blank" rel="noopener" href="https://github.com/prometheus/prometheus/releases/latest">Latest Release · prometheus&#x2F;prometheus</a></p>
<p>  用最新版本替换</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.53.1/prometheus-2.53.1.linux-amd64.tar.gz</span><br><span class="line">tar -xzvf prometheus-2.53.1.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">cd</span> prometheus-2.53.1.linux-amd64</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mv</span> prometheus promtool /usr/local/bin/</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/prometheus /var/lib/prometheus</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mv</span> prometheus.yml /etc/prometheus/prometheus.yml</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mv</span> consoles/ console_libraries/ /etc/prometheus/</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">rm</span> -r prometheus-2.53.1.linux-amd64.tar.gz</span><br><span class="line"><span class="built_in">rm</span> -r prometheus-2.53.1.linux-amd64</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> useradd -rs /bin/false prometheus</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">chown</span> -R prometheus: /etc/prometheus /var/lib/prometheus</span><br><span class="line">vim /etc/systemd/system/prometheus.service</span><br></pre></td></tr></table></figure>

<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=Prometheus</span><br><span class="line"><span class="attr">Wants</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"><span class="attr">After</span>=network-<span class="literal">on</span>line.target</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">User</span>=prometheus</span><br><span class="line"><span class="attr">Group</span>=prometheus</span><br><span class="line"><span class="attr">Type</span>=simple</span><br><span class="line"><span class="attr">Restart</span>=<span class="literal">on</span>-failure</span><br><span class="line"><span class="attr">RestartSec</span>=<span class="number">5</span>s</span><br><span class="line"><span class="attr">ExecStart</span>=/usr/local/bin/prometheus \</span><br><span class="line">    --config.file /etc/prometheus/prometheus.yml \</span><br><span class="line">    --storage.tsdb.path /var/lib/prometheus/ \</span><br><span class="line">    <span class="attr">--web.console.templates</span>=/etc/prometheus/consoles \</span><br><span class="line">    <span class="attr">--web.console.libraries</span>=/etc/prometheus/console_libraries \</span><br><span class="line">    <span class="attr">--web.listen-address</span>=<span class="number">0.0</span>.<span class="number">0.0</span>:<span class="number">9090</span> \</span><br><span class="line">    --web.enable-lifecycle \</span><br><span class="line">    <span class="attr">--log.level</span>=info</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> systemctl daemon-reload</span><br><span class="line"><span class="built_in">sudo</span> systemctl <span class="built_in">enable</span> --now prometheus</span><br><span class="line"><span class="built_in">sudo</span> systemctl status prometheus</span><br></pre></td></tr></table></figure>

<ul>
<li>此时可以通过 <code>http://&lt;Server IP&gt;:9090</code> 访问 Prometheus 仪表盘</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw allow 9090 comment <span class="string">&#x27;prometheus&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="Server-Add-Client-to-Server"><a href="#Server-Add-Client-to-Server" class="headerlink" title="(Server) Add Client to Server"></a>(Server) Add Client to Server</h3><ul>
<li>每次添加客户机时按以下方式更新 Prometheus</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/prometheus/prometheus.yml</span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;prometheus&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># metrics_path defaults to &#x27;/metrics&#x27;</span></span><br><span class="line">    <span class="comment"># scheme defaults to &#x27;http&#x27;.</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;localhost:9090&quot;</span>]</span><br><span class="line">  </span><br><span class="line">    <span class="comment"># 添加以下内容</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;remote_collector&quot;</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">1m</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;&lt;Client 1 IP&gt;:9100&quot;</span>, <span class="string">&quot;&lt;Client 2 IP&gt;:9100&quot;</span>]</span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">&#x27;&lt;Client 1 Name&gt;&#x27;</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">&#x27;&lt;Client 1 IP&gt;:9100&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">&#x27;&lt;Client 2 Name&gt;&#x27;</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">&#x27;&lt;Client 2 IP&gt;:9100&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart prometheus</span><br></pre></td></tr></table></figure>

<ul>
<li>前往 <code>&lt;Server IP&gt;:9090</code>, Status, Targets，将显示所有 Clients</li>
</ul>
<h3 id="Server-Grafana"><a href="#Server-Grafana" class="headerlink" title="(Server) Grafana"></a>(Server) Grafana</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> apt-get install -y apt-transport-https software-properties-common wget</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">mkdir</span> -p /etc/apt/keyrings/</span><br><span class="line">wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | <span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/keyrings/grafana.gpg &gt; /dev/null</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main&quot;</span> | <span class="built_in">sudo</span> <span class="built_in">tee</span> -a /etc/apt/sources.list.d/grafana.list</span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install grafana</span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now grafana-server.service</span><br><span class="line">systemctl status grafana-server</span><br><span class="line">ufw allow 3000 comment <span class="string">&#x27;grafana&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>此时可以通过 <code>&lt;Server IP&gt;:3000</code> 访问 Grafana</li>
</ul>
<h3 id="Server-Link-Grafana-and-Prometheus"><a href="#Server-Link-Grafana-and-Prometheus" class="headerlink" title="(Server) Link Grafana and Prometheus"></a>(Server) Link Grafana and Prometheus</h3><ol>
<li>浏览器访问 <code>&lt;Server IP&gt;:3000</code>，初始用户名和初试密码均为 <code>admin</code>，登录成功后修改密码</li>
<li>点击左上角三横线，展开 <code>Connections</code>，点击 <code>Data sources</code></li>
<li>点击 <code>Add data source</code>, <code>Prometheus</code><ul>
<li>URL: <code>http://localhost:9090</code></li>
</ul>
</li>
<li>点击 <code>Save &amp; test</code></li>
<li>点击左上角三横线，<code>Dashboards</code>, <code>New</code>, <code>Import</code></li>
<li>输入 ID，如 <code>1860</code>，点击 <code>Load</code>，底部选择数据源为 Prometheus，点击 <code>Import</code></li>
<li>完成，现在可以通过 <code>&lt;Server IP&gt;:3000</code> 查看仪表盘</li>
</ol>
<h2 id="Traffic-Statistics-vnstat"><a href="#Traffic-Statistics-vnstat" class="headerlink" title="Traffic Statistics: vnstat"></a>Traffic Statistics: vnstat</h2><p>使用 Grafana + Prometheus + node_exporter 可以实时监控客户端传递的数据，对各种实时数据的监控效果良好</p>
<p>然而，对于需要进行时间段汇总的任务，如流量统计等，效果非常有限，而且数据和实际值差别较大</p>
<p>由于其仅记录每个时间点的数据，无法像数据库那样根据客户端传输的数据更新每个时段的流量信息</p>
<p>因此，我采用 vnstat 进行流量信息统计，然后导出给 Prometheus，从而在 Grafana 面板上展示</p>
<p>但是我找了一圈没有找到 vnstat Exporter，只好自己手搓了一个，实现的效果略显粗糙，仅供参考</p>
<h3 id="Clients-vnstat"><a href="#Clients-vnstat" class="headerlink" title="(Clients) vnstat"></a>(Clients) vnstat</h3><ol>
<li>Install vnstat</li>
</ol>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt install vnstat</span><br><span class="line">systemctl <span class="built_in">enable</span> vnstat</span><br></pre></td></tr></table></figure>

<p>  vnstat 从安装完成后开始统计流量信息，每五分钟更新一次，如果还没有信息就稍等一会</p>
<ul>
<li><p>按小时查看流量</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@localhost:~# vnstat -h</span><br><span class="line"></span><br><span class="line"> eth0  /  hourly</span><br><span class="line"></span><br><span class="line">         hour        rx      |     tx      |    total    |   avg. rate</span><br><span class="line">     ------------------------+-------------+-------------+---------------</span><br><span class="line">     2024-08-01</span><br><span class="line">         21:00      9.07 MiB |   22.31 MiB |   31.39 MiB |   73.13 kbit/s</span><br><span class="line">         22:00      9.36 MiB |   22.78 MiB |   32.14 MiB |   74.90 kbit/s</span><br><span class="line">         23:00     10.91 MiB |   44.68 MiB |   55.59 MiB |  129.53 kbit/s</span><br><span class="line">     2024-08-02</span><br><span class="line">         00:00    118.04 MiB |    6.00 GiB |    6.11 GiB |   14.59 Mbit/s</span><br><span class="line">         01:00    124.24 GiB |    7.18 GiB |  131.42 GiB |  313.57 Mbit/s</span><br><span class="line">         02:00     45.43 GiB |    8.37 GiB |   53.80 GiB |  128.36 Mbit/s</span><br><span class="line">     ------------------------+-------------+-------------+---------------</span><br></pre></td></tr></table></figure>

<p>  此外，可以按 5 分钟 <code>-5</code>、日 <code>-d</code>、月 <code>-m</code>、年 <code>-y</code> 查看、导出为 json <code>--json</code></p>
</li>
</ul>
<ol start="2">
<li>创建 <code>vnstat_exporter.py</code> 脚本</li>
</ol>
<blockquote>
<p>只成功用 <code>prometheus_client</code> 写了一个 Python 脚本，对资源消耗较高，之后有机会重写成 Shell 脚本</p>
</blockquote>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">apt install python3-pip</span><br><span class="line">pip install prometheus-client</span><br><span class="line">vim /usr/local/bin/vnstat_exporter.py</span><br></pre></td></tr></table></figure>

  <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> start_http_server, Gauge</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define metrics</span></span><br><span class="line">traffic_gauge = Gauge(<span class="string">&#x27;vnstat_traffic&#x27;</span>, <span class="string">&#x27;Traffic usage from vnstat&#x27;</span>,</span><br><span class="line">                     [<span class="string">&#x27;interface&#x27;</span>, <span class="string">&#x27;time_unit&#x27;</span>, <span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;direction&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">parse_vnstat_output</span>(<span class="params">output</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Parses the vnstat JSON output and updates Prometheus metrics.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    data = json.loads(output)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> interface <span class="keyword">in</span> data.get(<span class="string">&#x27;interfaces&#x27;</span>, []):</span><br><span class="line">        iface_name = interface.get(<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;unknown&#x27;</span>)</span><br><span class="line">        traffic = interface.get(<span class="string">&#x27;traffic&#x27;</span>, &#123;&#125;)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Process traffic data for each time unit</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Process 5-minute data if available</span></span><br><span class="line">        <span class="keyword">for</span> entry <span class="keyword">in</span> traffic.get(<span class="string">&#x27;fiveminute&#x27;</span>, []):</span><br><span class="line">            timestamp = <span class="string">f&quot;<span class="subst">&#123;entry[<span class="string">&#x27;date&#x27;</span>][<span class="string">&#x27;year&#x27;</span>]&#125;</span>-<span class="subst">&#123;entry[<span class="string">&#x27;date&#x27;</span>][<span class="string">&#x27;month&#x27;</span>]:02d&#125;</span>-<span class="subst">&#123;entry[<span class="string">&#x27;date&#x27;</span>][<span class="string">&#x27;day&#x27;</span>]:02d&#125;</span> <span class="subst">&#123;entry[<span class="string">&#x27;time&#x27;</span>][<span class="string">&#x27;hour&#x27;</span>]:02d&#125;</span>:<span class="subst">&#123;entry[<span class="string">&#x27;time&#x27;</span>][<span class="string">&#x27;minute&#x27;</span>]:02d&#125;</span>&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;5-min data: <span class="subst">&#123;iface_name&#125;</span>, <span class="subst">&#123;timestamp&#125;</span>, rx=<span class="subst">&#123;entry.get(<span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>)&#125;</span>, tx=<span class="subst">&#123;entry.get(<span class="string">&#x27;tx&#x27;</span>, <span class="number">0</span>)&#125;</span>&quot;</span>)</span><br><span class="line">            traffic_gauge.labels(interface=iface_name, time_unit=<span class="string">&#x27;five_minute&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;total&#x27;</span>, direction=<span class="string">&#x27;in&#x27;</span>).<span class="built_in">set</span>(entry.get(<span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>))</span><br><span class="line">            traffic_gauge.labels(interface=iface_name, time_unit=<span class="string">&#x27;five_minute&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;total&#x27;</span>, direction=<span class="string">&#x27;out&#x27;</span>).<span class="built_in">set</span>(entry.get(<span class="string">&#x27;tx&#x27;</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Process hourly data if available</span></span><br><span class="line">        <span class="keyword">for</span> entry <span class="keyword">in</span> traffic.get(<span class="string">&#x27;hour&#x27;</span>, []):</span><br><span class="line">            timestamp = <span class="string">f&quot;<span class="subst">&#123;entry[<span class="string">&#x27;date&#x27;</span>][<span class="string">&#x27;year&#x27;</span>]&#125;</span>-<span class="subst">&#123;entry[<span class="string">&#x27;date&#x27;</span>][<span class="string">&#x27;month&#x27;</span>]:02d&#125;</span>-<span class="subst">&#123;entry[<span class="string">&#x27;date&#x27;</span>][<span class="string">&#x27;day&#x27;</span>]:02d&#125;</span> <span class="subst">&#123;entry[<span class="string">&#x27;time&#x27;</span>][<span class="string">&#x27;hour&#x27;</span>]:02d&#125;</span>:00&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Hour data: <span class="subst">&#123;iface_name&#125;</span>, <span class="subst">&#123;timestamp&#125;</span>, rx=<span class="subst">&#123;entry.get(<span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>)&#125;</span>, tx=<span class="subst">&#123;entry.get(<span class="string">&#x27;tx&#x27;</span>, <span class="number">0</span>)&#125;</span>&quot;</span>)</span><br><span class="line">            traffic_gauge.labels(interface=iface_name, time_unit=<span class="string">&#x27;hour&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;total&#x27;</span>, direction=<span class="string">&#x27;in&#x27;</span>).<span class="built_in">set</span>(entry.get(<span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>))</span><br><span class="line">            traffic_gauge.labels(interface=iface_name, time_unit=<span class="string">&#x27;hour&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;total&#x27;</span>, direction=<span class="string">&#x27;out&#x27;</span>).<span class="built_in">set</span>(entry.get(<span class="string">&#x27;tx&#x27;</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Process daily data if available</span></span><br><span class="line">        <span class="keyword">for</span> entry <span class="keyword">in</span> traffic.get(<span class="string">&#x27;day&#x27;</span>, []):</span><br><span class="line">            date = <span class="string">f&quot;<span class="subst">&#123;entry[<span class="string">&#x27;date&#x27;</span>][<span class="string">&#x27;year&#x27;</span>]&#125;</span>-<span class="subst">&#123;entry[<span class="string">&#x27;date&#x27;</span>][<span class="string">&#x27;month&#x27;</span>]:02d&#125;</span>-<span class="subst">&#123;entry[<span class="string">&#x27;date&#x27;</span>][<span class="string">&#x27;day&#x27;</span>]:02d&#125;</span>&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Day data: <span class="subst">&#123;iface_name&#125;</span>, <span class="subst">&#123;date&#125;</span>, rx=<span class="subst">&#123;entry.get(<span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>)&#125;</span>, tx=<span class="subst">&#123;entry.get(<span class="string">&#x27;tx&#x27;</span>, <span class="number">0</span>)&#125;</span>&quot;</span>)</span><br><span class="line">            traffic_gauge.labels(interface=iface_name, time_unit=<span class="string">&#x27;day&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;total&#x27;</span>, direction=<span class="string">&#x27;in&#x27;</span>).<span class="built_in">set</span>(entry.get(<span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>))</span><br><span class="line">            traffic_gauge.labels(interface=iface_name, time_unit=<span class="string">&#x27;day&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;total&#x27;</span>, direction=<span class="string">&#x27;out&#x27;</span>).<span class="built_in">set</span>(entry.get(<span class="string">&#x27;tx&#x27;</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Process monthly data if available</span></span><br><span class="line">        <span class="keyword">for</span> entry <span class="keyword">in</span> traffic.get(<span class="string">&#x27;month&#x27;</span>, []):</span><br><span class="line">            date = <span class="string">f&quot;<span class="subst">&#123;entry[<span class="string">&#x27;date&#x27;</span>][<span class="string">&#x27;year&#x27;</span>]&#125;</span>-<span class="subst">&#123;entry[<span class="string">&#x27;date&#x27;</span>][<span class="string">&#x27;month&#x27;</span>]:02d&#125;</span>&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Month data: <span class="subst">&#123;iface_name&#125;</span>, <span class="subst">&#123;date&#125;</span>, rx=<span class="subst">&#123;entry.get(<span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>)&#125;</span>, tx=<span class="subst">&#123;entry.get(<span class="string">&#x27;tx&#x27;</span>, <span class="number">0</span>)&#125;</span>&quot;</span>)</span><br><span class="line">            traffic_gauge.labels(interface=iface_name, time_unit=<span class="string">&#x27;month&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;total&#x27;</span>, direction=<span class="string">&#x27;in&#x27;</span>).<span class="built_in">set</span>(entry.get(<span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>))</span><br><span class="line">            traffic_gauge.labels(interface=iface_name, time_unit=<span class="string">&#x27;month&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;total&#x27;</span>, direction=<span class="string">&#x27;out&#x27;</span>).<span class="built_in">set</span>(entry.get(<span class="string">&#x27;tx&#x27;</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Process yearly data if available</span></span><br><span class="line">        <span class="keyword">for</span> entry <span class="keyword">in</span> traffic.get(<span class="string">&#x27;year&#x27;</span>, []):</span><br><span class="line">            date = <span class="string">f&quot;<span class="subst">&#123;entry[<span class="string">&#x27;date&#x27;</span>][<span class="string">&#x27;year&#x27;</span>]&#125;</span>&quot;</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;Year data: <span class="subst">&#123;iface_name&#125;</span>, <span class="subst">&#123;date&#125;</span>, rx=<span class="subst">&#123;entry.get(<span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>)&#125;</span>, tx=<span class="subst">&#123;entry.get(<span class="string">&#x27;tx&#x27;</span>, <span class="number">0</span>)&#125;</span>&quot;</span>)</span><br><span class="line">            traffic_gauge.labels(interface=iface_name, time_unit=<span class="string">&#x27;year&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;total&#x27;</span>, direction=<span class="string">&#x27;in&#x27;</span>).<span class="built_in">set</span>(entry.get(<span class="string">&#x27;rx&#x27;</span>, <span class="number">0</span>))</span><br><span class="line">            traffic_gauge.labels(interface=iface_name, time_unit=<span class="string">&#x27;year&#x27;</span>, <span class="built_in">type</span>=<span class="string">&#x27;total&#x27;</span>, direction=<span class="string">&#x27;out&#x27;</span>).<span class="built_in">set</span>(entry.get(<span class="string">&#x27;tx&#x27;</span>, <span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update_metrics</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Fetches vnstat data and updates Prometheus metrics.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        output = subprocess.check_output([<span class="string">&#x27;vnstat&#x27;</span>, <span class="string">&#x27;--json&#x27;</span>], text=<span class="literal">True</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Raw vnstat JSON output:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(output)  <span class="comment"># Print the raw JSON data for inspection</span></span><br><span class="line">        parse_vnstat_output(output)</span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Error fetching vnstat data: <span class="subst">&#123;e&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Command output: <span class="subst">&#123;e.output&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># Start Prometheus metrics server</span></span><br><span class="line">    start_http_server(<span class="number">9112</span>)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        update_metrics()</span><br><span class="line">        time.sleep(<span class="number">60</span>)  <span class="comment"># Update every 60 seconds</span></span><br></pre></td></tr></table></figure>


<ol start="3">
<li><p>创建 vnstat_exporter 服务</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/systemd/system/vnstat_exporter.service</span><br></pre></td></tr></table></figure>

 <figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[Unit]</span></span><br><span class="line"><span class="attr">Description</span>=vnstat exporter</span><br><span class="line"></span><br><span class="line"><span class="section">[Service]</span></span><br><span class="line"><span class="attr">ExecStart</span>=/usr/bin/python3 /usr/local/bin/vnstat_exporter.py</span><br><span class="line"><span class="attr">WorkingDirectory</span>=/root</span><br><span class="line"><span class="attr">Restart</span>=always</span><br><span class="line"><span class="attr">User</span>=root</span><br><span class="line"></span><br><span class="line"><span class="section">[Install]</span></span><br><span class="line"><span class="attr">WantedBy</span>=multi-user.target</span><br></pre></td></tr></table></figure>

 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl <span class="built_in">enable</span> --now vnstat_exporter</span><br></pre></td></tr></table></figure>
</li>
<li><p>现在可以前往 <code>&lt;Server IP&gt;:9112/metrics</code> 查看输出信息，如果没有稍等五分钟</p>
</li>
<li><p>启用防火墙</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ufw allow from &lt;Server IP&gt; to any port 9112 comment <span class="string">&#x27;vnstat_exporter&#x27;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="Server-Add-Client-to-Server-1"><a href="#Server-Add-Client-to-Server-1" class="headerlink" title="(Server) Add Client to Server"></a>(Server) Add Client to Server</h3><ol>
<li>编辑 Prometheus 配置</li>
</ol>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/prometheus/prometheus.yml</span><br></pre></td></tr></table></figure>

  <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;prometheus&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># metrics_path defaults to &#x27;/metrics&#x27;</span></span><br><span class="line">    <span class="comment"># scheme defaults to &#x27;http&#x27;.</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;localhost:9090&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;remote_collector&quot;</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;&lt;Client 1 IP&gt;:9100&quot;</span>, <span class="string">&quot;&lt;Client 2 IP&gt;:9100&quot;</span>]</span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">&#x27;&lt;Client 1 Name&gt;&#x27;</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">&#x27;&lt;Client 1 IP&gt;:9100&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">&#x27;&lt;Client 2 Name&gt;&#x27;</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">&#x27;&lt;Client 2 IP&gt;:9100&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 添加以下内容</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;vnstat_exporter&#x27;</span></span><br><span class="line">    <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;&lt;Client 1 IP&gt;:9112&quot;</span>, <span class="string">&quot;&lt;Client 2 IP&gt;:9112&quot;</span>]</span><br><span class="line">    <span class="attr">relabel_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">&#x27;&lt;Client 1 Name&gt;&#x27;</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">&#x27;&lt;Client 1 IP&gt;:9112&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">        <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">        <span class="attr">replacement:</span> <span class="string">&#x27;&lt;Client 2 Name&gt;&#x27;</span></span><br><span class="line">        <span class="attr">regex:</span> <span class="string">&#x27;&lt;Client 2 IP&gt;:9112&#x27;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>添加 Grafana 变量</li>
</ol>
<p>  在 Dashboard 点击 <code>齿轮</code>，<code>Variables</code>, <code>+ New variable</code></p>
<ul>
<li>Name: <code>Traffic_Unit</code></li>
<li>Label: <code>Traffic Unit</code></li>
<li>Query type: <code>Label values</code></li>
<li>Label: <code>time_unit</code></li>
<li>Metric: <code>vnstat_traffic</code></li>
</ul>
<p>  点击 <code>Apply</code></p>
<ol start="3">
<li>配置 Grafana 面板</li>
</ol>
<p>  点击 <code>Add</code>, <code>Visualization</code></p>
<p>  Query 里选择 <code>Code</code>，输入</p>
<ul>
<li><p>出口流量</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vnstat_traffic&#123;time_unit=&quot;$Traffic_Unit&quot;,type=&quot;total&quot;,direction=&quot;out&quot;,instance=&quot;$node&quot;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>入口流量</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vnstat_traffic&#123;time_unit=&quot;$Traffic_Unit&quot;,type=&quot;total&quot;,direction=&quot;in&quot;,instance=&quot;$node&quot;&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>双向流量</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sum(vnstat_traffic&#123;time_unit=&quot;$Traffic_Unit&quot;,type=&quot;total&quot;,direction=&quot;in&quot;,instance=&quot;$node&quot;&#125;) </span><br><span class="line">+ </span><br><span class="line">sum(vnstat_traffic&#123;time_unit=&quot;$Traffic_Unit&quot;,type=&quot;total&quot;,direction=&quot;out&quot;,instance=&quot;$node&quot;&#125;)</span><br></pre></td></tr></table></figure></li>
</ul>
<p>  右侧选项 <code>Standard Option</code>, <code>Unit</code> 选择 <code>bytes(IEC)</code></p>
<ol start="4">
<li>此时可以在顶上 Host 选择主机、在 Traffic Unit 选择统计周期</li>
</ol>

    </div>

    
    <div class="about">
        <h1>About this Post</h1>
        <div class="details">
            <p>This post is written by OwlllOvO, licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc/4.0">CC BY-NC 4.0</a>.</p>
        </div>
        
        <p class="tags">
            
            <i class="icon"></i>
            <a href="/tags/Server/" class="tag">#Server</a><a href="/tags/Monitor/" class="tag">#Monitor</a>
        </p>
        
    </div>
    

    <div class="container post-prev-next">
        
        <a href="/2024/09/28/2024-09-28-hdu-net-login/" class="next">
            <div>
                <div class="text">
                    <p class="label">Next</p>
                    <h3 class="title">HDU Net Login</h3>
                </div>
            </div>
        </a>
        
        
        <a href="/2024/07/25/2024-07-25-mac-manual/" class="prev">
            <div>
                <div class="text">
                    <p class="label">Previous</p>
                    <h3 class="title">Mac Manual</>
                </div>
            </div>
        </a>
        
    </div>

    
        
        
    
</article>

        <footer>
    <div class="inner">
        <div class="links">
            
            <div class="group">
                <h2 class="title">Blog</h2>
                
                <a href="/" class="item">Blog</a>
                
                <a href="/archives" class="item">Archives</a>
                
                <a href="/tags" class="item">Tags</a>
                
                <a href="/categories" class="item">Categories</a>
                
                <a href="/search" class="item">Search</a>
                
                <a href="/friends" class="item">Friends</a>
                
                <a href="/projects" class="item">Projects</a>
                
                <a href="/resume" class="item">Resume</a>
                
                <a href="/about" class="item">About</a>
                
                <a href="/atom.xml" class="item">RSS</a>
                
            </div>
            
            <div class="group">
                <h2 class="title">Projects</h2>
                
            </div>
            
            <div class="group">
                <h2 class="title">Me</h2>
                
                <a target="_blank" rel="noopener" href="https://github.com/OwlllOvO" class="item">GitHub</a>
                
                <a href="mailto:contact@pengbo.wang" class="item">Email</a>
                
            </div>
            
        </div>
        <span>&copy; 2024 OwlllOvO<br>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a> </span>
        
        
            <br>
            <div class="color-scheme-toggle" role="radiogroup" id="theme-color-scheme-toggle">
                <label>
                    <input type="radio" value="light">
                    <span>Light</span>
                </label>
                <label>
                    <input type="radio" value="dark">
                    <span>Dark</span>
                </label>
                <label>
                    <input type="radio" value="auto">
                    <span>Auto</span>
                </label>
            </div>
        
    </div>
</footer>


        
<script src="/js/main.js"></script>

        
        
        

        
        <script src="https://unpkg.com/scrollreveal"></script>
        <script>
            window.addEventListener('load', () => {
                ScrollReveal({ delay: 250, reset: true, easing: 'cubic-bezier(0, 0, 0, 1)' })
                ScrollReveal().reveal('.post-list-item .cover-img img')
                ScrollReveal().reveal('.post-list-item, .card, .content p img, .content .block-large img', { distance: '60px', origin: 'bottom', duration: 800 })
            })
        </script>
        
    </body>
</html>